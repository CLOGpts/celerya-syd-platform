<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Test Algoritmo Semantico - AI Chirurgica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .firebase-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
        }
        
        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .example-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .example-chip {
            padding: 8px 15px;
            background: #f5f5f5;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .example-chip:hover {
            background: #667eea;
            color: white;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .status-dot.error {
            background: #dc3545;
        }
        
        .status-dot.warning {
            background: #ffc107;
        }
        
        .schema-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .field-chip {
            padding: 8px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .field-chip .type {
            font-weight: 600;
            color: #1976d2;
        }
        
        .results {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-table tr:hover {
            background: #f9f9f9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .alert.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .alert.warning {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .alert.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .how-it-works {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .step {
            text-align: center;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        
        .step h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .step p {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Test Algoritmo Semantico</h1>
            <p>AI Chirurgica - 95% Query con Codice, 5% con AI</p>
        </div>

        <!-- Configurazione Firebase -->
        <div class="card">
            <h2>‚öôÔ∏è Configurazione Firebase</h2>
            <div class="firebase-config">
                <div class="input-group">
                    <label>API Key</label>
                    <input type="text" id="apiKey" value="AIzaSyDAc-Fp6WWB8c7d1TPSlJiFvVVwxSPHo3E">
                </div>
                <div class="input-group">
                    <label>Project ID</label>
                    <input type="text" id="projectId" value="adept-presence-464522-s3">
                </div>
                <div class="input-group">
                    <label>Auth Domain</label>
                    <input type="text" id="authDomain" value="adept-presence-464522-s3.firebaseapp.com">
                </div>
                <div class="input-group">
                    <label>Collezione</label>
                    <input type="text" id="collection" value="magazzino" placeholder="es. magazzino">
                </div>
            </div>
            <button class="btn" onclick="initializeFirebase()">üîå Connetti e Analizza</button>
        </div>

        <!-- Schema Info -->
        <div class="card" id="schemaCard" style="display: none;">
            <h3>üìä Schema Analizzato</h3>
            <div class="status">
                <div class="status-item">
                    <span class="status-dot"></span>
                    <span id="recordCount">0 record</span>
                </div>
                <div class="status-item">
                    <span id="fieldCount">0 campi</span>
                </div>
                <div class="status-item">
                    <span id="confidence">Confidenza: 0%</span>
                </div>
            </div>
            <div class="schema-info" id="schemaInfo"></div>
        </div>

        <!-- Ricerca -->
        <div class="card" id="searchCard" style="display: none;">
            <h2>üîç Ricerca Semantica</h2>
            <div class="search-box">
                <input type="text" id="searchQuery" placeholder="Scrivi in italiano: 'articoli sotto 10 euro', 'prodotti che scadono'...">
                <button class="btn" onclick="search()">Cerca</button>
            </div>
            
            <div class="example-queries">
                <div class="example-chip" onclick="setQuery('articoli sotto 10 euro')">articoli sotto 10 euro</div>
                <div class="example-chip" onclick="setQuery('prodotti che scadono questo mese')">prodotti che scadono questo mese</div>
                <div class="example-chip" onclick="setQuery('viti disponibili')">viti disponibili</div>
                <div class="example-chip" onclick="setQuery('codici che iniziano con ART')">codici che iniziano con ART</div>
                <div class="example-chip" onclick="setQuery('prodotti pi√π costosi')">prodotti pi√π costosi</div>
                <div class="example-chip" onclick="setQuery('scorte basse')">scorte basse</div>
            </div>
        </div>

        <!-- Risultati -->
        <div class="card" id="resultsCard" style="display: none;">
            <h2>üìã Risultati</h2>
            <div id="resultsStatus"></div>
            <div class="results" id="results"></div>
        </div>

        <!-- Come Funziona -->
        <div class="card">
            <h2>üéØ Come Funziona l'Algoritmo</h2>
            <div class="how-it-works">
                <div class="step">
                    <div class="step-number">1</div>
                    <h3>Auto-Apprendimento</h3>
                    <p>Analizza i dati e capisce automaticamente i tipi: codici, prezzi, date, descrizioni</p>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <h3>Interpretazione</h3>
                    <p>Capisce l'italiano usando sinonimi e pattern matching intelligente</p>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <h3>Query Native</h3>
                    <p>Genera query Firestore ottimizzate, velocissime e senza AI</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        let db = null;
        let schema = null;
        let collectionName = null;
        
        // Test iniziale
        window.onload = function() {
            console.log('Pagina caricata');
            console.log('Firebase disponibile:', typeof firebase !== 'undefined');
            if (typeof firebase !== 'undefined') {
                console.log('Firebase modules:', {
                    app: typeof firebase.app,
                    auth: typeof firebase.auth,
                    firestore: typeof firebase.firestore
                });
            }
        };

        // Inizializza Firebase
        async function initializeFirebase() {
            console.log('Inizializzazione Firebase...');
            
            try {
                const config = {
                    apiKey: document.getElementById('apiKey').value,
                    authDomain: document.getElementById('authDomain').value,
                    projectId: document.getElementById('projectId').value
                };
                
                console.log('Config:', config);
                
                // Controlla se Firebase √® gi√† inizializzato
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                } else {
                    firebase.app(); // usa app esistente
                }
                
                db = firebase.firestore();
                console.log('Firestore inizializzato');
                
                // Login anonimo per test
                console.log('Login anonimo...');
                await firebase.auth().signInAnonymously();
                console.log('Login completato');
                
                collectionName = document.getElementById('collection').value;
                console.log('Collezione:', collectionName);
                
                // Analizza schema
                await analyzeSchema();
                
                document.getElementById('schemaCard').style.display = 'block';
                document.getElementById('searchCard').style.display = 'block';
                
                showAlert('Connesso e schema analizzato!', 'success');
            } catch (error) {
                console.error('Errore:', error);
                showAlert('Errore: ' + error.message, 'error');
                alert('Errore Firebase: ' + error.message + '\n\nControlla la console per dettagli (F12)');
            }
        }

        // Analizza lo schema della collezione
        async function analyzeSchema() {
            const snapshot = await db.collection(collectionName).limit(100).get();
            const records = snapshot.docs.map(doc => doc.data());
            
            if (records.length === 0) {
                showAlert('Collezione vuota!', 'warning');
                return;
            }
            
            schema = analyzeFields(records);
            
            // Mostra info schema
            document.getElementById('recordCount').textContent = snapshot.size + ' record campione';
            document.getElementById('fieldCount').textContent = Object.keys(schema).length + ' campi';
            
            // Mostra campi
            const schemaHtml = Object.entries(schema).map(([field, info]) => `
                <div class="field-chip">
                    <div>${field}</div>
                    <div class="type">${info.type}</div>
                </div>
            `).join('');
            
            document.getElementById('schemaInfo').innerHTML = schemaHtml;
        }

        // Analizza i tipi di campo
        function analyzeFields(records) {
            const fields = {};
            const sample = records[0];
            
            for (const [key, value] of Object.entries(sample)) {
                if (key.startsWith('_')) continue;
                
                fields[key] = {
                    type: detectType(value),
                    samples: records.slice(0, 5).map(r => r[key])
                };
            }
            
            return fields;
        }

        // Rileva il tipo di un campo
        function detectType(value) {
            if (value === null || value === undefined) return 'NULL';
            
            const str = String(value);
            
            // Patterns
            if (/^[A-Z]{2,5}[\-\_]?\d{2,6}$/.test(str)) return 'CODE';
            if (/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(str)) return 'DATE_IT';
            if (/^\d{4}-\d{2}-\d{2}/.test(str)) return 'DATE_ISO';
            if (/^\d+([.,]\d{1,2})?$/.test(str.replace(/[‚Ç¨$¬£]/g, ''))) return 'PRICE';
            if (/^\d+$/.test(str)) return 'QUANTITY';
            if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(str)) return 'EMAIL';
            if (str.length > 30) return 'DESCRIPTION';
            
            return 'TEXT';
        }

        // Interpreta la query
        function interpretQuery(query) {
            const normalized = query.toLowerCase();
            const tokens = normalized.split(/\s+/);
            
            const interpretation = {
                filters: [],
                searchTerms: [],
                intent: 'SEARCH'
            };
            
            // Cerca prezzi
            if (normalized.includes('euro') || normalized.includes('‚Ç¨')) {
                interpretation.intent = 'PRICE_FILTER';
                const numbers = normalized.match(/\d+/g);
                if (numbers) {
                    const value = parseInt(numbers[0]);
                    if (normalized.includes('sotto') || normalized.includes('meno')) {
                        interpretation.filters.push({
                            field: findFieldByType('PRICE'),
                            operator: '<',
                            value: value
                        });
                    } else if (normalized.includes('sopra') || normalized.includes('pi√π')) {
                        interpretation.filters.push({
                            field: findFieldByType('PRICE'),
                            operator: '>',
                            value: value
                        });
                    }
                }
            }
            
            // Cerca scadenze
            if (normalized.includes('scad')) {
                interpretation.intent = 'DATE_FILTER';
                const dateField = findFieldByType('DATE_IT') || findFieldByType('DATE_ISO');
                if (dateField) {
                    const today = new Date();
                    let endDate = new Date();
                    
                    if (normalized.includes('mese')) {
                        endDate.setMonth(endDate.getMonth() + 1);
                    } else if (normalized.includes('settimana')) {
                        endDate.setDate(endDate.getDate() + 7);
                    } else {
                        endDate.setDate(endDate.getDate() + 30);
                    }
                    
                    interpretation.filters.push({
                        field: dateField,
                        operator: 'range',
                        value: { start: today, end: endDate }
                    });
                }
            }
            
            // Cerca codici
            if (normalized.includes('codic') && normalized.includes('inizia')) {
                interpretation.intent = 'CODE_FILTER';
                const words = tokens.filter(t => t.length > 2 && t.toUpperCase() === t);
                if (words.length > 0) {
                    interpretation.filters.push({
                        field: findFieldByType('CODE'),
                        operator: 'startsWith',
                        value: words[0].toUpperCase()
                    });
                }
            }
            
            // Termini di ricerca generici
            const stopwords = ['il', 'la', 'i', 'le', 'un', 'una', 'di', 'da', 'che', 'con'];
            interpretation.searchTerms = tokens
                .filter(t => !stopwords.includes(t) && t.length > 2)
                .filter(t => !['sotto', 'sopra', 'euro', 'mese', 'scad'].some(s => t.includes(s)));
            
            return interpretation;
        }

        // Trova campo per tipo
        function findFieldByType(type) {
            for (const [field, info] of Object.entries(schema)) {
                if (info.type === type) return field;
            }
            return null;
        }

        // Esegui ricerca
        async function search() {
            const query = document.getElementById('searchQuery').value;
            if (!query) return;
            
            const startTime = Date.now();
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('results').innerHTML = '<div class="loading"><div class="spinner"></div>Ricerca in corso...</div>';
            
            try {
                const interpretation = interpretQuery(query);
                let firestoreQuery = db.collection(collectionName);
                
                // Applica filtri
                for (const filter of interpretation.filters) {
                    if (filter.operator === 'range') {
                        // Per range di date
                        firestoreQuery = firestoreQuery
                            .where(filter.field, '>=', filter.value.start.toISOString())
                            .where(filter.field, '<=', filter.value.end.toISOString());
                    } else if (filter.operator === 'startsWith') {
                        // Per prefissi
                        firestoreQuery = firestoreQuery
                            .where(filter.field, '>=', filter.value)
                            .where(filter.field, '<', filter.value + '\uf8ff');
                    } else {
                        // Altri operatori
                        firestoreQuery = firestoreQuery.where(filter.field, filter.operator, filter.value);
                    }
                }
                
                // Limita risultati
                firestoreQuery = firestoreQuery.limit(50);
                
                // Esegui query
                const snapshot = await firestoreQuery.get();
                let results = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                // Filtra per termini di ricerca se necessario
                if (interpretation.searchTerms.length > 0) {
                    results = results.filter(record => {
                        const text = JSON.stringify(record).toLowerCase();
                        return interpretation.searchTerms.every(term => text.includes(term));
                    });
                }
                
                const executionTime = Date.now() - startTime;
                
                // Mostra risultati
                showResults(results, interpretation, executionTime);
                
            } catch (error) {
                showAlert('Errore ricerca: ' + error.message, 'error');
                document.getElementById('results').innerHTML = '';
            }
        }

        // Mostra risultati
        function showResults(results, interpretation, executionTime) {
            const statusHtml = `
                <div class="alert info">
                    <strong>Risultati:</strong> ${results.length} record | 
                    <strong>Tempo:</strong> ${executionTime}ms | 
                    <strong>Intent:</strong> ${interpretation.intent} | 
                    <strong>Filtri:</strong> ${interpretation.filters.length}
                </div>
            `;
            
            document.getElementById('resultsStatus').innerHTML = statusHtml;
            
            if (results.length === 0) {
                document.getElementById('results').innerHTML = '<p>Nessun risultato trovato.</p>';
                return;
            }
            
            // Crea tabella risultati
            const fields = Object.keys(results[0]).filter(k => !k.startsWith('_')).slice(0, 6);
            
            const tableHtml = `
                <table class="results-table">
                    <thead>
                        <tr>
                            ${fields.map(f => `<th>${f}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${results.slice(0, 20).map(row => `
                            <tr>
                                ${fields.map(f => `<td>${String(row[f] || '-').substring(0, 50)}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${results.length > 20 ? `<p style="text-align: center; margin-top: 10px;">Mostrati 20 di ${results.length} risultati</p>` : ''}
            `;
            
            document.getElementById('results').innerHTML = tableHtml;
        }

        // Imposta query di esempio
        function setQuery(query) {
            document.getElementById('searchQuery').value = query;
        }

        // Mostra alert
        function showAlert(message, type) {
            const alertHtml = `<div class="alert ${type}">${message}</div>`;
            const card = document.getElementById('searchCard') || document.querySelector('.card');
            card.insertAdjacentHTML('afterbegin', alertHtml);
            
            setTimeout(() => {
                const alert = card.querySelector('.alert');
                if (alert) alert.remove();
            }, 3000);
        }
    </script>
</body>
</html>